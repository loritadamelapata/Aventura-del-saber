<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aventura del Saber</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest and Theme -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#C4B5FD"/> <!-- Lavender -->
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F5F3FF; /* Light Lavender */ }
        h1, h2, h3, h4, .font-display { font-family: 'Baloo 2', cursive; }
        .bg-primary { background-color: #8B5CF6; } /* Purple */
        .text-primary { color: #8B5CF6; }
        .bg-secondary { background-color: #A7F3D0; } /* Mint */
        .text-secondary { color: #059669; } /* Dark Green */
        .bg-accent { background-color: #FBCFE8; } /* Pink */
        .text-accent { color: #DB2777; } /* Hot Pink */
        
        /* Custom animations */
        @keyframes correct-answer { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .correct { animation: correct-answer 0.5s ease-in-out; background-color: #A7F3D0 !important; color: #047857 !important; }
        .incorrect { animation: shake 0.5s ease-in-out; background-color: #FECACA !important; color: #B91C1C !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #8B5CF6; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: spin 1s linear infinite; }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="p-4 md:p-6 max-w-4xl mx-auto">
        <!-- Dashboard Screen -->
        <div id="screen-dashboard">
            <header class="text-center mb-6">
                <h1 class="text-5xl md:text-6xl font-bold text-primary">Aventura del Saber</h1>
                <p class="text-lg text-gray-600 mt-2">¬°Un nuevo mundo de aprendizaje te espera!</p>
            </header>
            <div id="blocks-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <!-- Blocks generated by JS -->
            </div>
        </div>

        <!-- Block Detail Screen -->
        <div id="screen-block-detail" class="hidden">
            <header class="mb-6 flex items-center justify-between">
                <div>
                    <h2 id="block-title" class="text-3xl md:text-4xl font-bold text-primary"></h2>
                </div>
                <button id="back-to-dashboard" class="bg-white border-2 border-purple-400 text-purple-500 font-bold py-2 px-4 rounded-full hover:bg-purple-50 transition-transform transform hover:scale-105">‚Üê Volver</button>
            </header>
            <div id="topics-container" class="space-y-4">
                <!-- Topics generated by JS -->
            </div>
             <div id="project-card" class="hidden mt-8 bg-gradient-to-br from-pink-300 to-purple-400 p-6 rounded-2xl shadow-lg text-white animate-fade-in">
                <h3 class="font-display text-2xl font-bold mb-2">‚ú® ¬°Proyecto Desbloqueado! ‚ú®</h3>
                <h4 id="project-title" class="font-display text-xl font-bold mb-4"></h4>
                <p id="project-description" class="mb-4"></p>
                <p class="font-bold text-sm">Materias involucradas: <span id="project-subjects"></span></p>
            </div>
        </div>
        
        <!-- Learning Screen (Powered by Gemini) -->
        <div id="screen-learning" class="hidden">
            <header class="mb-4 flex items-center justify-between">
                <h2 id="learning-title" class="text-2xl md:text-3xl font-bold text-primary"></h2>
                <button id="back-to-block" class="bg-white border-2 border-purple-400 text-purple-500 font-bold py-2 px-4 rounded-full hover:bg-purple-50 transition-transform transform hover:scale-105">‚Üê Volver</button>
            </header>
            <div class="bg-white p-6 rounded-2xl shadow-lg min-h-[400px] flex flex-col justify-between">
                <div id="learning-content-wrapper" class="relative">
                    <div id="learning-content" class="text-lg leading-relaxed space-y-4 prose max-w-none prose-p:my-2 prose-li:my-1 prose-h3:text-secondary prose-strong:text-primary">
                        <!-- Gemini's explanation will be injected here -->
                    </div>
                     <div id="loader-container" class="hidden absolute inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center rounded-2xl">
                        <div class="loader"></div>
                        <p class="mt-4 text-primary font-semibold">Tu tutor IA est√° preparando la lecci√≥n...</p>
                    </div>
                </div>
                 <div class="mt-6 flex justify-between items-center">
                    <button id="speak-button" class="bg-accent text-accent-darker p-3 rounded-full hover:bg-pink-300 transition-transform transform hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                    </button>
                    <button id="start-quiz-btn" class="bg-secondary text-secondary-darker font-bold py-3 px-8 rounded-full hover:opacity-90 transition-transform transform hover:scale-105">¬°Probar mis conocimientos!</button>
                </div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="screen-quiz" class="hidden">
             <div id="quiz-loader" class="hidden absolute inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center rounded-2xl z-20">
                <div class="loader"></div>
                <p class="mt-4 text-primary font-semibold">Creando un cuestionario √∫nico para ti...</p>
            </div>
            <div id="quiz-content">
                <header class="mb-4">
                    <h2 id="quiz-title" class="text-3xl font-bold text-center text-primary">Cuestionario</h2>
                </header>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                         <p id="question-counter" class="text-gray-600 font-semibold"></p>
                         <p id="quiz-score" class="text-lg font-bold text-green-600"></p>
                    </div>
                    <div id="quiz-question" class="text-xl font-semibold mb-6 min-h-[60px]"></div>
                    <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="screen-results" class="hidden text-center animate-fade-in">
            <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md mx-auto">
                <h2 id="results-title" class="text-4xl font-bold text-yellow-500 mb-4"></h2>
                <div id="results-icon" class="text-7xl mb-4"></div>
                <p id="results-score" class="text-2xl font-semibold mb-2"></p>
                <p id="results-message" class="text-gray-600 mb-6"></p>
                <button id="back-to-block-from-results" class="w-full bg-primary text-white font-bold py-3 px-6 rounded-full hover:opacity-90 transition-transform transform hover:scale-105">Volver al Bloque</button>
            </div>
        </div>
        
        <!-- Daily Reading Modal -->
        <div id="daily-reading-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full p-6 relative animate-fade-in">
                <h2 class="text-2xl font-bold text-center text-cyan-600 mb-4 font-display">Lectura del D√≠a üå§Ô∏è</h2>
                <div id="reading-content" class="max-h-[60vh] overflow-y-auto pr-2">
                    <h3 id="reading-title" class="text-xl font-bold mb-2"></h3>
                    <div id="reading-text" class="prose text-justify"></div>
                    <hr class="my-4">
                    <div id="reading-quiz"></div>
                </div>
                <div class="text-center mt-4">
                    <button id="reading-done-btn" class="hidden bg-cyan-500 text-white font-bold py-2 px-6 rounded-full hover:bg-cyan-600">¬°Entendido!</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- GEMINI API CONFIGURATION ---
        // IMPORTANTE: Debes obtener tu propia API Key de Google AI Studio y pegarla aqu√≠.
        const apiKey = "AIzaSyCEDcMkIET19qJmmEGeE4wOwoTYWJU7OKY"; // <--- ¬°PEGA TU API KEY AQU√ç!
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // Data for all learning blocks and topics
        const learningData = [
            { block: 1, title: "El Comienzo de la Aventura", project: { title: "Mi C√°psula del Tiempo Personal", description: "¬°Vamos a crear una c√°psula del tiempo! En una caja, guarda un cuento que hayas escrito (Espa√±ol), un dibujo de las reglas de tu casa (Formaci√≥n C√≠vica), un mapa del tesoro en tu patio (Geograf√≠a) y una l√≠nea de tiempo de tu vida (Historia). ¬°La abriremos en un a√±o para ver cu√°nto has cambiado!", subjects: ["Espa√±ol", "Historia", "Geograf√≠a", "Formaci√≥n C√≠vica"] }, topics: [ { id: 1, subject: "Matem√°ticas", title: "Valor de los n√∫meros y nombres" }, { id: 2, subject: "Matem√°ticas", title: "Orden y comparaci√≥n de n√∫meros naturales" }, { id: 3, subject: "Matem√°ticas", title: "Sucesiones num√©ricas" }, { id: 4, subject: "Espa√±ol", title: "El cuento, personajes y escenarios" }, { id: 5, subject: "Espa√±ol", title: "Relaciones temporales y causales" }, { id: 6, subject: "Espa√±ol", title: "Verbos en pasado / presente hist√≥rico" }, { id: 7, subject: "Ciencias", title: "La Tierra y sus movimientos (rotaci√≥n, traslaci√≥n)" }, { id: 8, subject: "Ciencias", title: "D√≠a y noche / estaciones" }, { id: 9, subject: "Ciencias", title: "La Luna y sus fases" }, { id: 10, subject: "Historia", title: "El tiempo hist√≥rico (l√≠neas de tiempo, pasado‚Äìpresente‚Äìfuturo)" }, { id: 11, subject: "Geograf√≠a", title: "Orientaci√≥n y ubicaci√≥n en mapas, puntos cardinales" }, { id: 12, subject: "Historia del Arte", title: "Arte prehist√≥rico (pinturas rupestres, escultura)" }, { id: 13, subject: "Formaci√≥n C√≠vica y √âtica", title: "Convivencia y reglas en la vida diaria" } ] },
            { block: 2, title: "Explorando el Mundo", project: { title: "Mi Propio Museo en Casa", description: "Crea una exhibici√≥n sobre los primeros pobladores de Am√©rica. Usa plastilina para hacer pir√°mides (Arte Mesoamericano), dibuja mapas de sus rutas (Geograf√≠a) y escribe textos informativos con recuadros sobre c√≥mo viv√≠an (Espa√±ol). ¬°Invita a tu familia a la inauguraci√≥n!", subjects: ["Historia", "Historia del Arte", "Geograf√≠a", "Espa√±ol"] }, topics: [ { id: 14, subject: "Matem√°ticas", title: "Suma y resta de n√∫meros naturales" }, { id: 15, subject: "Matem√°ticas", title: "N√∫meros romanos" }, { id: 16, subject: "Matem√°ticas", title: "Suma y resta con decimales" }, { id: 17, subject: "Espa√±ol", title: "Portada, contraportada e √≠ndice" }, { id: 18, subject: "Espa√±ol", title: "Formularios de registro y caracter√≠sticas gr√°ficas" }, { id: 19, subject: "Espa√±ol", title: "Textos informativos con gr√°ficos y recuadros" }, { id: 20, subject: "Ciencias", title: "Los eclipses" }, { id: 21, subject: "Ciencias", title: "El calor y su obtenci√≥n" }, { id: 22, subject: "Ciencias", title: "Temperatura y calor" }, { id: 23, subject: "Historia", title: "Primeros pobladores de Am√©rica y M√©xico" }, { id: 24, subject: "Geograf√≠a", title: "M√©xico en el mundo (continentes y oc√©anos)" }, { id: 25, subject: "Historia del Arte", title: "Arte mesoamericano (pir√°mides, c√≥dices, cer√°mica)" }, { id: 26, subject: "Formaci√≥n C√≠vica y √âtica", title: "Valores personales y familiares (respeto, empat√≠a, responsabilidad)" } ] },
            { block: 3, title: "Transformando la Materia", project: { title: "¬°Cocinando con Ciencia y Arte!", description: "Vamos a preparar una ensalada de frutas. Separa las frutas (mezclas), observa c√≥mo cambian (efectos del calor si usas alguna fruta cocida), y crea un c√≥mic (Espa√±ol) sobre los superh√©roes de la comida saludable (Formaci√≥n C√≠vica). Al final, representa las porciones de fruta con fracciones (Matem√°ticas).", subjects: ["Ciencias", "Matem√°ticas", "Espa√±ol", "Formaci√≥n C√≠vica"] }, topics: [ { id: 27, subject: "Matem√°ticas", title: "Fracciones: propias, impropias, mixtas" }, { id: 28, subject: "Matem√°ticas", title: "Fracciones equivalentes" }, { id: 29, subject: "Matem√°ticas", title: "Representaci√≥n de fracciones en la recta" }, { id: 30, subject: "Espa√±ol", title: "Organizadores de informaci√≥n" }, { id: 31, subject: "Espa√±ol", title: "C√≥mic e historieta" }, { id: 32, subject: "Espa√±ol", title: "Texto descriptivo" }, { id: 33, subject: "Ciencias", title: "Efectos del calor en los materiales" }, { id: 34, subject: "Ciencias", title: "Cambios de estado de la materia" }, { id: 35, subject: "Ciencias", "title": "Sustancias puras y mezclas" }, { id: 36, subject: "Historia", title: "Culturas mesoamericanas (olmecas, mayas, mexicas, zapotecas)" }, { id: 37, subject: "Geograf√≠a", title: "Regiones naturales de M√©xico (climas, fauna, vegetaci√≥n)" }, { id: 38, subject: "Historia del Arte", title: "Arte en la Colonia (arquitectura, retablos, pintura religiosa)" }, { id: 39, subject: "Formaci√≥n C√≠vica y √âtica", title: "H√°bitos de autocuidado (higiene, alimentaci√≥n, ejercicio)" } ] },
            // Other blocks are omitted for brevity, but the structure is the same
        ];
        
        const dailyReadings = [
            { title: "El Zorro y las Uvas", text: `<p>Un zorro muy hambriento vio unos racimos de uvas que colgaban de una parra. Parec√≠an jugosas y maduras. "¬°Qu√© delicia!", pens√≥. "Son justo lo que necesito para calmar mi hambre".</p><p>El zorro se acerc√≥ y salt√≥ con todas sus fuerzas para alcanzarlas, pero se qued√≥ corto. Descans√≥ un momento y volvi√≥ a intentarlo, una y otra vez, pero las uvas estaban demasiado altas. Cansado y sin poder lograr su objetivo, se dio por vencido.</p><p>Mientras se alejaba, se dijo a s√≠ mismo para consolarse: "En realidad, no las quer√≠a. Seguro que todav√≠a est√°n verdes".</p>`, quiz: [ { q: "¬øQu√© fruta quer√≠a comer el zorro?", o: ["Uvas", "Manzanas", "Pl√°tanos", "Peras"], a: "Uvas" }, { q: "¬øPor qu√© no pudo alcanzar las uvas?", o: ["Porque no ten√≠a hambre", "Porque estaban muy altas", "Porque no le gustaban", "Porque eran de pl√°stico"], a: "Porque estaban muy altas" }, { q: "¬øQu√© dijo el zorro al final para sentirse mejor?", o: ["Que volver√≠a ma√±ana", "Que buscar√≠a otra cosa", "Que estaban verdes", "Que las uvas son aburridas"], a: "Que estaban verdes" } ] }
        ];

        let state = { progress: {}, currentScreen: 'dashboard', currentBlockId: 1, currentTopicId: null, quizData: [], quizStep: 0, quizScore: 0 };
        
        const screens = {
            dashboard: document.getElementById('screen-dashboard'),
            blockDetail: document.getElementById('screen-block-detail'),
            learning: document.getElementById('screen-learning'),
            quiz: document.getElementById('screen-quiz'),
            results: document.getElementById('screen-results'),
        };

        const blocksContainer = document.getElementById('blocks-container');
        const topicsContainer = document.getElementById('topics-container');

        function navigateTo(screenName) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
            }
            state.currentScreen = screenName;
        }

        function saveProgress() {
            localStorage.setItem('aventuraSaberProgress', JSON.stringify(state.progress));
        }

        function loadProgress() {
            const saved = localStorage.getItem('aventuraSaberProgress');
            if (saved) {
                state.progress = JSON.parse(saved);
            }
        }

        // --- GEMINI API FUNCTIONS ---
        async function fetchFromGemini(systemInstruction, userPrompt, responseSchema = null) {
            if (!apiKey) {
                return { error: "Por favor, a√±ade una API Key de Gemini en el c√≥digo para continuar." };
            }
            
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: responseSchema ? { responseMimeType: "application/json", responseSchema } : {},
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) { throw new Error(`API error: ${response.status}`); }
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                return { data: text };
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return { error: "¬°Ups! El tutor IA no est√° disponible ahora. Int√©ntalo m√°s tarde." };
            }
        }

        async function fetchLesson(topicTitle) {
            document.getElementById('loader-container').classList.remove('hidden');
            document.getElementById('learning-content').innerHTML = '';
            
            const systemPrompt = "Eres un tutor de IA llamado 'Gemi', s√∫per amigable, paciente y creativo. Tu misi√≥n es explicarle temas a una ni√±a de 9 a√±os. Usa un lenguaje muy sencillo, analog√≠as divertidas, ejemplos claros y hazle preguntas para que reflexione. Formatea tu respuesta con Markdown, usando t√≠tulos (###), listas (*), y negritas (**). Al final, prop√≥n una actividad creativa o 'hands-on' muy simple relacionada con el tema.";
            const userPrompt = `Expl√≠came el tema "${topicTitle}" como si tuviera 9 a√±os.`;
            
            const result = await fetchFromGemini(systemPrompt, userPrompt);
            document.getElementById('loader-container').classList.add('hidden');

            if (result.error) {
                document.getElementById('learning-content').innerHTML = `<p class="text-red-500">${result.error}</p>`;
            } else {
                 // Basic Markdown to HTML conversion
                let html = result.data
                    .replace(/### (.*)/g, '<h3 class="font-display text-xl text-secondary mt-4">$1</h3>')
                    .replace(/\*\s(.*)/g, '<li>$1</li>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');

                // Wrap lists
                html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
                
                document.getElementById('learning-content').innerHTML = html;
            }
        }

        async function fetchQuiz(topicTitle) {
            document.getElementById('quiz-loader').classList.remove('hidden');
            document.getElementById('quiz-content').classList.add('hidden');

            const systemPrompt = "Eres un creador de cuestionarios educativos para ni√±os de 9 a√±os. Genera un cuestionario interactivo de 5 preguntas sobre el tema proporcionado. Las preguntas deben ser claras, directas y con 4 opciones de respuesta. Aseg√∫rate de que solo una opci√≥n sea la correcta.";
            const userPrompt = `Crea un cuestionario sobre "${topicTitle}".`;
            const schema = {
                type: "OBJECT",
                properties: {
                    quiz: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                q: { type: "STRING" },
                                o: { type: "ARRAY", items: { type: "STRING" } },
                                a: { type: "STRING" }
                            },
                            required: ["q", "o", "a"]
                        }
                    }
                },
                required: ["quiz"]
            };

            const result = await fetchFromGemini(systemPrompt, userPrompt, schema);
             document.getElementById('quiz-loader').classList.add('hidden');
             document.getElementById('quiz-content').classList.remove('hidden');

            if (result.error) {
                alert(result.error);
                renderBlockDetail(state.currentBlockId);
                navigateTo('blockDetail');
            } else {
                try {
                    const quizData = JSON.parse(result.data).quiz;
                    state.quizData = quizData;
                    startQuiz(topicTitle);
                } catch(e) {
                    alert("Hubo un problema al crear el cuestionario. ¬°Int√©ntalo de nuevo!");
                    renderBlockDetail(state.currentBlockId);
                    navigateTo('blockDetail');
                }
            }
        }
        
        function startQuiz(topicTitle) {
            const quiz = state.quizData;
            if (!quiz || quiz.length === 0) {
                alert("No se pudo cargar el cuestionario.");
                return;
            }
            document.getElementById('quiz-title').textContent = `Cuestionario: ${topicTitle}`;
            state.quizStep = 0;
            state.quizScore = 0;
            updateQuizContent();
            navigateTo('quiz');
        }

        function updateQuizContent() {
            const quiz = state.quizData;
            document.getElementById('question-counter').textContent = `Pregunta ${state.quizStep + 1} de ${quiz.length}`;
            document.getElementById('quiz-score').textContent = `Puntos: ${state.quizScore}`;
            
            const question = quiz[state.quizStep];
            document.getElementById('quiz-question').textContent = question.q;
            
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';
            
            const shuffledOptions = [...question.o].sort(() => Math.random() - 0.5);

            shuffledOptions.forEach(option => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'p-4 rounded-lg text-lg bg-gray-100 hover:bg-purple-100 transition text-left';
                optionBtn.textContent = option;
                optionBtn.onclick = (e) => handleAnswer(e.target, option === question.a);
                optionsContainer.appendChild(optionBtn);
            });
        }
        
        function handleAnswer(button, isCorrect) {
            document.querySelectorAll('#quiz-options button').forEach(btn => btn.disabled = true);
            
            if (isCorrect) {
                state.quizScore++;
                button.classList.add('correct');
            } else {
                button.classList.add('incorrect');
                const correctAnswer = state.quizData[state.quizStep].a;
                document.querySelectorAll('#quiz-options button').forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct');
                    }
                });
            }

            setTimeout(() => {
                state.quizStep++;
                if (state.quizStep < state.quizData.length) {
                    updateQuizContent();
                } else {
                    renderResults();
                }
            }, 1500);
        }

        function renderResults() {
             const totalQuestions = state.quizData.length;
             const scorePercentage = (state.quizScore / totalQuestions) * 100;
             
             const resultsTitle = document.getElementById('results-title');
             const resultsIcon = document.getElementById('results-icon');
             const resultsScore = document.getElementById('results-score');
             const resultsMessage = document.getElementById('results-message');
             
             resultsScore.textContent = `Obtuviste ${state.quizScore} de ${totalQuestions} respuestas correctas.`;
             
             if(scorePercentage >= 80) { // Pass
                resultsTitle.textContent = "¬°Excelente Trabajo!";
                resultsIcon.textContent = 'üèÜ';
                resultsMessage.textContent = '¬°Has dominado este tema!';
                state.progress[state.currentTopicId] = 'completed';
                saveProgress();
                checkBlockCompletion();
             } else {
                resultsTitle.textContent = "¬°Casi lo logras!";
                resultsIcon.textContent = 'üí™';
                resultsMessage.textContent = 'No te preocupes. ¬°Repasa el tema y vuelve a intentarlo!';
             }
             navigateTo('results');
        }

        function checkBlockCompletion() {
            const block = learningData.find(b => b.block === state.currentBlockId);
            const isCompletedNow = block.topics.every(t => state.progress[t.id] === 'completed');
            const alreadyNotified = localStorage.getItem(`blockNotified_${state.currentBlockId}`);

            if (isCompletedNow && !alreadyNotified) {
                sendProgressEmail(block.title);
                localStorage.setItem(`blockNotified_${state.currentBlockId}`, 'true');
            }
        }

        function sendProgressEmail(blockTitle) {
            const recipient = "loritadamelapata@gmail.com";
            const subject = `¬°Avance en Aventura del Saber!`;
            const body = `¬°Felicidades!\n\nSe ha completado exitosamente el bloque "${blockTitle}" en la app Aventura del Saber.\n\n¬°Sigue as√≠!`;
            const mailtoLink = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }

        function renderDashboard() {
            blocksContainer.innerHTML = '';
            const lastCompletedBlock = Math.max(0, ...learningData.filter(b => b.topics.every(t => state.progress[t.id] === 'completed')).map(b => b.block));
            const highestUnlockedBlock = lastCompletedBlock + 1;

            learningData.forEach(block => {
                const isLocked = block.block > highestUnlockedBlock;
                const completedTopics = block.topics.filter(t => state.progress[t.id] === 'completed').length;
                const totalTopics = block.topics.length;
                const progressPercentage = totalTopics > 0 ? (completedTopics / totalTopics) * 100 : 0;
                
                const blockEl = document.createElement('div');
                blockEl.className = `p-5 rounded-2xl shadow-lg transition-all duration-300 ${isLocked ? 'bg-gray-200 opacity-60' : 'bg-white cursor-pointer hover:shadow-xl hover:-translate-y-1'}`;
                blockEl.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-2xl font-bold font-display ${isLocked ? 'text-gray-500' : 'text-gray-800'}">${block.title}</h3>
                        <span class="text-3xl font-bold ${isLocked ? 'text-gray-400' : 'text-primary'}">${isLocked ? 'üîí' : block.block}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="h-2.5 rounded-full ${progressPercentage === 100 ? 'bg-secondary' : 'bg-primary'}" style="width: ${progressPercentage}%"></div>
                    </div>
                `;
                if (!isLocked) {
                    blockEl.addEventListener('click', () => {
                        state.currentBlockId = block.block;
                        renderBlockDetail(block.block);
                        navigateTo('blockDetail');
                    });
                }
                blocksContainer.appendChild(blockEl);
            });
        }
        
        function renderBlockDetail(blockId) {
            const block = learningData.find(b => b.block === blockId);
            if (!block) return;
            
            document.getElementById('block-title').textContent = block.title;
            topicsContainer.innerHTML = '';

            const subjectGroups = block.topics.reduce((acc, topic) => {
                (acc[topic.subject] = acc[topic.subject] || []).push(topic);
                return acc;
            }, {});
            
            const subjectColors = { "Matem√°ticas": "border-blue-400", "Espa√±ol": "border-red-400", "Ciencias": "border-green-400", "Historia": "border-yellow-400", "Geograf√≠a": "border-indigo-400", "Historia del Arte": "border-pink-400", "Formaci√≥n C√≠vica y √âtica": "border-purple-400" };
            const subjectIcons = { "Matem√°ticas": 'üé≤', "Espa√±ol": 'üìñ', "Ciencias": 'üî¨', "Historia": 'üìú', "Geograf√≠a": 'üó∫Ô∏è', "Historia del Arte": 'üé®', "Formaci√≥n C√≠vica y √âtica": 'ü§ù' };

            for (const subject in subjectGroups) {
                const groupContainer = document.createElement('div');
                groupContainer.className = `bg-white p-4 rounded-xl shadow border-l-4 ${subjectColors[subject] || 'border-gray-400'}`;
                groupContainer.innerHTML = `<h4 class="text-xl font-bold font-display mb-3">${subjectIcons[subject] || '‚≠ê'} ${subject}</h4>`;

                const list = document.createElement('div');
                list.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3';
                
                subjectGroups[subject].forEach(topic => {
                    const isCompleted = state.progress[topic.id] === 'completed';
                    const topicEl = document.createElement('button');
                    topicEl.className = `p-3 rounded-lg text-left w-full transition flex items-center justify-between ${isCompleted ? 'bg-green-100 text-green-800' : 'bg-gray-100 hover:bg-purple-100'}`;
                    topicEl.innerHTML = `<span>${topic.title}</span><span class="text-xl">${isCompleted ? '‚úÖ' : '‚ñ∂Ô∏è'}</span>`;
                    topicEl.onclick = () => {
                        state.currentTopicId = topic.id;
                        document.getElementById('learning-title').textContent = topic.title;
                        navigateTo('learning');
                        fetchLesson(topic.title);
                    };
                    list.appendChild(topicEl);
                });
                groupContainer.appendChild(list);
                topicsContainer.appendChild(groupContainer);
            }

            const allTopicsCompleted = block.topics.every(t => state.progress[t.id] === 'completed');
            const projectCard = document.getElementById('project-card');
            if (allTopicsCompleted) {
                document.getElementById('project-title').textContent = block.project.title;
                document.getElementById('project-description').textContent = block.project.description;
                document.getElementById('project-subjects').textContent = block.project.subjects.join(', ');
                projectCard.classList.remove('hidden');
            } else {
                projectCard.classList.add('hidden');
            }
        }
        
        // --- EVENT LISTENERS ---
        document.getElementById('back-to-dashboard').addEventListener('click', () => { renderDashboard(); navigateTo('dashboard'); });
        document.getElementById('back-to-block').addEventListener('click', () => { renderBlockDetail(state.currentBlockId); navigateTo('blockDetail'); });
        document.getElementById('back-to-block-from-results').addEventListener('click', () => { renderBlockDetail(state.currentBlockId); navigateTo('blockDetail'); });
        document.getElementById('start-quiz-btn').addEventListener('click', () => {
            const topic = learningData.flatMap(b => b.topics).find(t => t.id === state.currentTopicId);
            fetchQuiz(topic.title);
        });
        
        // --- Init ---
        function init() {
            loadProgress();
            renderDashboard();
            navigateTo('dashboard');
            // Daily reading logic can be added here
        }

        init();
    </script>
</body>
</html>


